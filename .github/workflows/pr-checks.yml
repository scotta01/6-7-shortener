name: PR Checks

on:
  pull_request:
    branches:
      - main
      - master
  push:
    branches:
      - main
      - master

jobs:
  # Type checking and linting
  quality:
    name: Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Type check
        run: npm run type-check

      - name: Lint
        run: npm run lint

  # Run all tests with coverage
  test:
    name: Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Run tests
        run: npm test

  # Security: Dependency scanning
  dependency-scan:
    name: Dependency Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Run npm audit
        run: npm audit --audit-level=moderate
        continue-on-error: true

      - name: Check for vulnerable packages
        run: |
          echo "Checking for known vulnerabilities..."
          npm audit --json > audit-report.json || true

          # Check if there are high or critical vulnerabilities
          CRITICAL=$(cat audit-report.json | grep -o '"critical":[0-9]*' | grep -o '[0-9]*' || echo "0")
          HIGH=$(cat audit-report.json | grep -o '"high":[0-9]*' | grep -o '[0-9]*' || echo "0")

          echo "Critical vulnerabilities: $CRITICAL"
          echo "High vulnerabilities: $HIGH"

          if [ "$CRITICAL" -gt "0" ] || [ "$HIGH" -gt "0" ]; then
            echo "::warning::Found $CRITICAL critical and $HIGH high severity vulnerabilities"
            cat audit-report.json
          fi

  # Security: Check for secrets in code
  secret-scan:
    name: Secret Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: TruffleHog OSS
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --debug --only-verified

  # Build verification
  build:
    name: Build Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Build with Wrangler
        run: npx wrangler deploy --dry-run --outdir=dist
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

  # Security: SSRF and validation tests
  security-validation:
    name: Security Validation Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm install

      - name: Run security-focused tests
        run: npm test -- test/unit/validator.test.ts
        env:
          VITEST_REPORTER: verbose

      - name: Verify SSRF protection
        run: |
          echo "Verifying SSRF protection is in place..."
          if grep -r "localhost\|127\.0\.0\.1\|10\.\|192\.168\." src/shortener/validator.ts; then
            echo "âœ“ SSRF protection patterns found in validator"
          else
            echo "::error::SSRF protection may be missing"
            exit 1
          fi

  # PR size check
  pr-size:
    name: PR Size Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check PR size
        run: |
          git fetch origin ${{ github.base_ref }}
          CHANGES=$(git diff --shortstat origin/${{ github.base_ref }}...HEAD | grep -oE '[0-9]+ files? changed' | grep -oE '[0-9]+' || echo "0")
          ADDITIONS=$(git diff --shortstat origin/${{ github.base_ref }}...HEAD | grep -oE '[0-9]+ insertion' | grep -oE '[0-9]+' || echo "0")

          echo "Files changed: $CHANGES"
          echo "Lines added: $ADDITIONS"

          if [ "$CHANGES" -gt "50" ]; then
            echo "::warning::Large PR: $CHANGES files changed. Consider breaking into smaller PRs."
          fi

          if [ "$ADDITIONS" -gt "1000" ]; then
            echo "::warning::Large PR: $ADDITIONS lines added. Consider breaking into smaller PRs."
          fi

  # All checks must pass
  all-checks:
    name: All Checks Passed
    runs-on: ubuntu-latest
    needs: [quality, test, dependency-scan, secret-scan, build, security-validation, pr-size]
    if: always()
    steps:
      - name: Check all jobs
        run: |
          if [ "${{ needs.quality.result }}" != "success" ] || \
             [ "${{ needs.test.result }}" != "success" ] || \
             [ "${{ needs.dependency-scan.result }}" != "success" ] || \
             [ "${{ needs.secret-scan.result }}" != "success" ] || \
             [ "${{ needs.build.result }}" != "success" ] || \
             [ "${{ needs.security-validation.result }}" != "success" ]; then
            echo "One or more required checks failed"
            exit 1
          fi
          echo "All required checks passed!"
